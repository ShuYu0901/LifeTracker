<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Life Logger</title>
    <style>
        :root {
            --bg: #000000;
            --bg-alert: #2a0505;
            --header-bg: rgba(0, 0, 0, 0.95);
            --header-alert: #500;
            --card: #1a1a1a;
            --text: #ffffff;
            --text-muted: #888;
            --accent: #FFD700;       /* Èáë */
            --accent-green: #00FF00; /* Á∂† */
            --accent-blue: #00FFFF;  /* Ëóç */
            --danger: #FF0055;
            --border: #333;
            --radius: 0px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Courier New', Courier, monospace, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 120px; height: 100vh; overflow-y: scroll; transition: background-color 0.3s; }

        .header { position: sticky; top: 0; z-index: 10; background: var(--header-bg); border-bottom: 1px solid var(--border); padding: 15px; text-align: center; transition: background-color 0.3s; }
        .header h1 { margin: 0; font-size: 18px; letter-spacing: 2px; text-transform: uppercase; }

        .section { padding: 15px; display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }

        .card { background: var(--card); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        h2 { margin-top: 0; font-size: 14px; color: var(--text-muted); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; letter-spacing: 1px; }

        input, select, textarea {
            width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: white; 
            font-size: 16px; margin-bottom: 10px; outline: none; font-family: inherit; border-radius: 0;
            -webkit-appearance: none; appearance: none;
        }
        input:focus, textarea:focus { border-color: var(--accent); }
        .row { display: flex; gap: 10px; align-items: center; }

        .action-btn { 
            width: 100%; background: var(--text); color: #000; border: none; padding: 15px; 
            font-weight: bold; font-size: 16px; cursor: pointer; text-transform: uppercase; margin-top: 5px;
        }
        .action-btn:active { opacity: 0.8; }
        .btn-small { padding: 5px 10px; font-size: 12px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; }

        .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .template-btn { 
            background: #111; border: 1px solid #444; color: #888; padding: 15px 5px; cursor: pointer; 
            font-size: 12px; text-transform: uppercase; transition: 0.2s;
        }
        .template-btn.active { border-color: var(--accent-green); color: var(--accent-green); background: #0a1a0a; }

        .checklist-item { display: flex; align-items: center; padding: 12px; background: #111; margin-bottom: 8px; border: 1px solid #333; cursor: pointer; }
        .checklist-item.checked { opacity: 0.4; text-decoration: line-through; border-color: #222; }
        .checklist-box { width: 20px; height: 20px; border: 2px solid var(--accent); margin-right: 15px; display: flex; align-items: center; justify-content: center; }
        .checklist-item.checked .checklist-box { background: var(--accent); }
        .checklist-item.checked .checklist-box::after { content: '‚úì'; color: black; font-weight: bold; font-size: 14px; }

        .stats-controls { display: flex; gap: 10px; margin-bottom: 15px; background: var(--card); padding: 15px; border: 1px solid var(--border); flex-wrap: wrap; }
        .date-group { flex: 1; display: flex; flex-direction: column; min-width: 120px; }
        .date-group label { font-size: 10px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .date-group input { margin-bottom: 0; text-align: center; min-width: 0; width: 100%; padding: 8px 5px; height: 40px; font-size: 14px; }

        .log-list { list-style: none; padding: 0; }
        .log-item { background: #111; padding: 15px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent); }
        .log-content { display: flex; flex-direction: column; gap: 2px; }
        .log-date-label { font-size: 10px; color: #666; }
        .delete-btn { color: #666; background: none; border: none; font-size: 20px; padding: 0 10px; cursor: pointer; }

        .chart-container { height: 200px; width: 100%; border-left: 1px solid #444; border-bottom: 1px solid #444; margin-top: 20px; position: relative; }
        svg { width: 100%; height: 100%; overflow: visible; }
        polyline { fill: none; stroke: var(--text); stroke-width: 2; vector-effect: non-scaling-stroke; }
        .chart-dot { fill: #000; stroke: var(--text); stroke-width: 2; r: 3; }

        .tag-chip { background: #333; padding: 5px 10px; font-size: 12px; display: inline-block; margin: 2px; border: 1px solid #555; cursor: pointer; }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(20px, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { color: #555; text-align: center; flex: 1; cursor: pointer; transition: 0.2s; }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; filter: grayscale(1); transition: 0.2s; }
        .nav-label { font-size: 10px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .nav-item.active .nav-icon { filter: grayscale(0); transform: scale(1.1); }
        .nav-item.active .nav-label { color: var(--text); }

        .home-date-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; background: #111; padding: 10px; border: 1px solid #333; }
        .home-date-bar input { margin: 0; height: 40px; border: 1px solid #444; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="app-title">Life Logger</h1>
    </div>

    <div id="view-home" class="section active" style="padding-bottom: 120px;">
        
        <div class="home-date-bar">
            <div style="flex:1">
                <input type="date" id="current-record-date" onchange="handleDateChange()">
            </div>
            <button class="btn-small" style="height:40px; padding:0 15px;" onclick="resetToToday()">TODAY</button>
        </div>

        <div class="card">
            <h2>üí∞ Ê∂àË≤ª (Expense) <button class="btn-small" onclick="openSettings('finance')">TAGS</button></h2>
            <div class="row">
                <select id="finance-tag"><option>Loading...</option></select>
            </div>
            <div class="row">
                <input type="number" id="finance-amount" placeholder="ÈáëÈ°ç (Amount)" style="flex:1">
            </div>
            <input type="text" id="finance-note" placeholder="ÂÇôË®ª (Note)">
            <button class="action-btn" style="background: var(--accent-blue);" onclick="addRecord('finance')">ADD EXPENSE</button>
        </div>

        <div class="card">
            <h2>üî• È£≤È£ü (Calories) <button class="btn-small" onclick="openSettings('diet')">TAGS</button></h2>
            <select id="diet-tag"><option>Loading...</option></select>
            <div class="row">
                <input type="number" id="diet-cal" placeholder="ÁÜ±Èáè (kCal)" style="flex:1">
            </div>
            <button class="action-btn" style="background: var(--accent-green); color:black;" onclick="addRecord('diet')">ADD CALORIES</button>
        </div>

        <div class="card">
            <h2>üí§ Áù°Áú† (Sleep)</h2>
            <div class="row">
                <input type="number" id="sleep-input" placeholder="Â∞èÊôÇ (Hours)" step="0.1">
                <button class="action-btn" style="width:auto; background: #fff;" onclick="addRecord('sleep')">SAVE</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öñÔ∏è È´îÈáç (Weight)</h2>
            <div class="row">
                <input type="number" id="weight-input" placeholder="ÂÖ¨Êñ§ (kg)" step="0.1">
                <button class="action-btn" style="width:auto; background: var(--accent);" onclick="addRecord('weight')">SAVE</button>
            </div>
        </div>

        <div class="card">
            <h2>üìù LOGS (<span id="log-list-date-label">Selected Date</span>)</h2>
            <ul id="today-list" class="log-list"></ul>
        </div>
    </div>

    <div id="view-fitness" class="section" style="padding-bottom: 120px;">
        
        <div class="card" style="border-top: 5px solid var(--accent-green);">
            <h2>üí™ Ë®ìÁ∑¥ËèúÂñÆ (TEMPLATES)</h2>
            <div id="gym-templates-container" class="template-grid"></div>
        </div>

        <div class="card">
            <h2>üìã ÁõÆÂâçË™≤Ë°® (CHECKLIST) 
                <button id="edit-toggle-btn" class="btn-small" onclick="toggleEditMode()">‚úèÔ∏è Á∑®ËºØ</button>
            </h2>

            <div id="checklist-view">
                <div id="checklist-container"></div>
            </div>

            <div id="edit-view" style="display:none;">
                <textarea id="fitness-plan-input" rows="8" placeholder="Ëº∏ÂÖ•ËèúÂñÆÔºå‰∏ÄË°å‰∏ÄÂÄã..." oninput="autoSaveFitnessPlan()"></textarea>
                <p style="color:#666; font-size:12px; margin-top:5px;">* Ê≠£Âú®Ëº∏ÂÖ•ÊôÇËá™ÂãïÂÑ≤Â≠ò (Auto Save)</p>
            </div>
            
            <button class="action-btn" style="margin-top:20px; background:var(--accent-green); color:black;" onclick="finishWorkout()">ÂÆåÊàêË®ìÁ∑¥ (FINISH)</button>
        </div>
    </div>

    <div id="view-stats" class="section" style="padding-bottom: 120px;">
        
        <div class="stats-controls">
            <div class="date-group">
                <label>FROM</label>
                <input type="date" id="stat-start" onchange="calculateStats()">
            </div>
            <div class="date-group">
                <label>TO</label>
                <input type="date" id="stat-end" onchange="calculateStats()">
            </div>
        </div>

        <div class="card">
             <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:center;">
                <div>
                    <div style="font-size:24px; color:var(--accent-blue)" id="val-expense">0</div>
                    <div style="font-size:10px; color:#666">EXPENSE</div>
                </div>
                <div>
                    <div style="font-size:24px; color:var(--accent-green)" id="val-cal">0</div>
                    <div style="font-size:10px; color:#666">AVG CAL</div>
                </div>
                <div>
                    <div style="font-size:24px; color:white" id="val-sleep">0</div>
                    <div style="font-size:10px; color:#666">AVG SLEEP</div>
                </div>
                <div>
                    <div style="font-size:24px; color:var(--accent)" id="val-weight">--</div>
                    <div style="font-size:10px; color:#666">WEIGHT</div>
                </div>
             </div>
        </div>
        
        <div class="card">
            <h2>üìú HISTORY LOGS</h2>
            <ul id="stats-log-list" class="log-list"></ul>
        </div>

        <div class="card">
            <h2>üìâ WEIGHT TREND</h2>
            <div id="weight-chart-wrapper" class="chart-container"></div>
        </div>

        <div class="card">
            <h2>üè∑ TAGS</h2>
            <select id="setting-category" onchange="renderTagsSetting()">
                <option value="finance">Finance</option>
                <option value="diet">Diet</option>
            </select>
            <div id="tags-display" style="margin: 15px 0;"></div>
            <div class="row">
                <input type="text" id="new-tag-input" placeholder="New Tag Name">
                <button class="btn-small" onclick="addNewTag()">ADD</button>
            </div>
        </div>

        <div class="card">
            <h2>üíæ BACKUP</h2>
            <button class="action-btn" style="background:#333; color:white; border:1px solid #555;" onclick="exportData()">DOWNLOAD JSON</button>
            <button class="action-btn" style="background:#333; color:white; border:1px solid #555; margin-top:10px;" onclick="document.getElementById('import-file').click()">RESTORE FILE</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
        </div>
        
        <div class="card">
            <button class="action-btn" style="background:var(--danger); color:white;" onclick="clearAllData()">RESET APP</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">HOME</div>
        </div>
        <div class="nav-item" onclick="switchTab('fitness')">
            <div class="nav-icon">üí™</div>
            <div class="nav-label">GYM</div>
        </div>
        <div class="nav-item" onclick="switchTab('stats')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">STATS</div>
        </div>
    </div>

    <script>
        const DB_NAME = 'LifeLoggerV12'; // ÁâàÊú¨Êõ¥Êñ∞
        const DB_VERSION = 12;
        let db;
        
        let activeTemplateIdx = 0; 
        let loadedGymTemplates = [];

        // [Êñ∞Â¢û] Auto Save Timer
        let autoSaveTimer = null;

        const DEFAULT_TEMPLATES = [
            { name: 'üèãÔ∏è ÂÖ®Ë∫´', content: "Jumping Jacks (30s)\nWall Sit (30s)\nPush-ups (10 reps)\nSquats (15 reps)\nPlank (30s)\nBurpees (10 reps)" },
            { name: 'ü¶µ ËÖøÈÉ®', content: "Squats (15 reps)\nLunges (10 each)\nSide Leg Raise (15 each)\nCalf Raise (20 reps)\nWall Sit (45s)" },
            { name: 'üí™ ‰∏äÂçäË∫´', content: "Push-ups (10 reps)\nTricep Dips (12 reps)\nArm Circles (30s)\nPlank Shoulder Tap (20 reps)\nDiamond Push-ups (8 reps)" },
            { name: 'üèÉ ÊúâÊ∞ß', content: "High Knees (30s)\nButt Kicks (30s)\nJumping Jacks (30s)\nMountain Climbers (30s)\nBurpees (30s)" }
        ];

        window.onload = function() {
            initDB().then(() => {
                resetToToday();
                setDefaultDateRange();
                refreshUI();
            }).catch(err => console.error(err));
        };

        function getLocalISODate(date) {
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().split('T')[0];
        }

        function handleDateChange() {
            const picker = document.getElementById('current-record-date');
            const today = getLocalISODate(new Date());
            if(picker.value !== today) {
                document.body.style.backgroundColor = 'var(--bg-alert)';
                document.querySelector('.header').style.backgroundColor = 'var(--header-alert)';
                document.getElementById('app-title').innerText = "‚ö†Ô∏è Ê≠∑Âè≤Á¥ÄÈåÑÊ®°Âºè (PAST)";
            } else {
                document.body.style.backgroundColor = 'var(--bg)';
                document.querySelector('.header').style.backgroundColor = 'var(--header-bg)';
                document.getElementById('app-title').innerText = "Life Logger";
            }
            loadHomeLogs();
        }

        function resetToToday() {
            const today = getLocalISODate(new Date());
            document.getElementById('current-record-date').value = today;
            handleDateChange();
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('logs')) db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                req.onsuccess = (e) => {
                    db = e.target.result;
                    checkInitData().then(resolve);
                };
                req.onerror = (e) => reject("DB Error");
            });
        }

        async function checkInitData() {
            const defaults = {
                'tags_finance': ['Lunch', 'Dinner', 'Transport', 'Shopping', 'Rent'],
                'tags_diet': ['Chicken', 'Eggs', 'Rice', 'Whey', 'Fruit'],
                'fitness_plan': DEFAULT_TEMPLATES[0].content, 
                'gym_templates': DEFAULT_TEMPLATES 
            };
            const tx = db.transaction(['settings'], 'readwrite');
            const store = tx.objectStore('settings');
            for (let key in defaults) {
                await new Promise(resolve => {
                    const getReq = store.get(key);
                    getReq.onsuccess = (e) => {
                        if (!e.target.result) store.put({ key, value: defaults[key] });
                        resolve();
                    };
                });
            }
            return new Promise(r => tx.oncomplete = r);
        }

        function renderGymTemplates() {
            const tx = db.transaction(['settings'], 'readonly');
            tx.objectStore('settings').get('gym_templates').onsuccess = (e) => {
                const templates = e.target.result?.value || DEFAULT_TEMPLATES;
                loadedGymTemplates = templates;
                const container = document.getElementById('gym-templates-container');
                container.innerHTML = '';
                templates.forEach((tpl, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'template-btn';
                    if(index === activeTemplateIdx) btn.classList.add('active');
                    btn.innerText = tpl.name;
                    btn.onclick = function() { applyTemplateByIndex(index, this); };
                    container.appendChild(btn);
                });
            };
        }

        function applyTemplateByIndex(index, btnElement) {
            document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            activeTemplateIdx = index;
            const planText = loadedGymTemplates[index].content;
            updatePlanInDB(planText, false); 
        }

        function updatePlanInDB(planText, isUpdateTemplate = false) {
            const tx = db.transaction(['settings'], 'readwrite');
            const store = tx.objectStore('settings');

            store.put({key:'fitness_plan', value: planText});

            if (isUpdateTemplate && loadedGymTemplates.length > 0) {
                loadedGymTemplates[activeTemplateIdx].content = planText;
                store.put({key:'gym_templates', value: loadedGymTemplates});
            }

            tx.oncomplete = () => {
                renderChecklist(planText);
                
                // [ÈóúÈçµ‰øÆÊ≠£] Â¶ÇÊûúÁï∂Ââç active element ÊòØÊñáÂ≠óÊ°ÜÔºåÂ∞±‰∏çË¶ÅÂéªË¶ÜËìãÂÆÉÁöÑÂÄºÔºåÈÅøÂÖçÊ∏∏Ê®ô‰∫ÇË∑≥
                if(document.activeElement !== document.getElementById('fitness-plan-input')) {
                    document.getElementById('fitness-plan-input').value = planText;
                }

                if(isUpdateTemplate) {
                    renderGymTemplates();
                }
            };
        }

        function renderChecklist(planText) {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            if(!planText) return;
            const items = planText.split('\n').filter(i => i.trim() !== '');
            items.forEach((item) => {
                const div = document.createElement('div');
                div.className = 'checklist-item';
                div.onclick = function() { this.classList.toggle('checked'); };
                div.innerHTML = `<div class="checklist-box"></div><div>${item}</div>`;
                container.appendChild(div);
            });
        }

        // [Êñ∞Â¢û] Ëá™ÂãïÂÑ≤Â≠òÂáΩÂºè (Debounce)
        function autoSaveFitnessPlan() {
            const v = document.getElementById('fitness-plan-input').value;
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                // ÂÇ≥ÂÖ• trueÔºåË°®Á§∫ÊâìÂ≠óÁöÑÂÖßÂÆπË¶ÅÂêåÊ≠•ÂõûÂØ´Âà∞Ê®°ÊùøË®≠ÂÆö‰∏≠
                updatePlanInDB(v, true);  
            }, 400);
        }

        function toggleEditMode() {
            const listDiv = document.getElementById('checklist-view');
            const editDiv = document.getElementById('edit-view');
            const btn = document.getElementById('edit-toggle-btn');
            
            if(listDiv.style.display === 'none') {
                saveFitnessPlanText();
                listDiv.style.display = 'block';
                editDiv.style.display = 'none';
                btn.innerText = "‚úèÔ∏è Á∑®ËºØ";
                btn.style.background = "#333";
                btn.style.color = "#fff";
            } else {
                listDiv.style.display = 'none';
                editDiv.style.display = 'block';
                btn.innerText = "üíæ ÂÆåÊàê (DONE)";
                btn.style.background = "var(--accent-green)";
                btn.style.color = "black";
            }
        }

        function saveFitnessPlanText() {
            const v = document.getElementById('fitness-plan-input').value;
            updatePlanInDB(v, true);
        }
        
        function finishWorkout() {
            addRecord('fitness');
            document.querySelectorAll('.checklist-item').forEach(el => el.classList.remove('checked'));
            alert('WORKOUT RECORDED! üí™');
        }

        // --- Áµ±Ë®àËàáÊó•Êúü ---
        function setDefaultDateRange() {
            const now = new Date();
            const todayStr = getLocalISODate(now);
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const firstDayStr = getLocalISODate(firstDay);
            const startInput = document.getElementById('stat-start');
            const endInput = document.getElementById('stat-end');
            if(startInput && endInput) {
                startInput.value = firstDayStr;
                endInput.value = todayStr;
            }
        }

        function calculateStats() {
            const start = document.getElementById('stat-start').value;
            const end = document.getElementById('stat-end').value;
            if(!start || !end) return;

            const tx = db.transaction(['logs'], 'readonly');
            tx.objectStore('logs').getAll().onsuccess = (e) => {
                const allLogs = e.target.result;
                const logs = allLogs.filter(l => l.date >= start && l.date <= end);
                
                const exp = logs.filter(l=>l.category==='finance').reduce((s,i)=>s+(i.amount||0),0);
                document.getElementById('val-expense').innerText = exp;

                const days = Math.max(1, (new Date(end)-new Date(start))/(86400000)+1);
                const dietLogs = logs.filter(l=>l.category==='diet');
                const totalCal = dietLogs.reduce((s,i)=>s+(i.calories||0),0);
                document.getElementById('val-cal').innerText = Math.round(totalCal / days);

                const sleepLogs = logs.filter(l=>l.category==='sleep');
                const totalSleep = sleepLogs.reduce((s,i)=>s+(i.hours||0),0);
                const avgSleep = sleepLogs.length ? (totalSleep / sleepLogs.length).toFixed(1) : 0;
                document.getElementById('val-sleep').innerText = avgSleep;

                const wLogs = allLogs.filter(l=>l.category==='weight').sort((a,b)=>a.timestamp-b.timestamp);
                if(wLogs.length) {
                    document.getElementById('val-weight').innerText = wLogs[wLogs.length-1].weight;
                    const rangeW = wLogs.filter(l => l.date >= start && l.date <= end);
                    renderChart(rangeW);
                }
                renderHistoryList(logs);
            };
        }

        function renderHistoryList(logs) {
            const list = document.getElementById('stats-log-list');
            list.innerHTML = '';
            logs.sort((a,b) => b.timestamp - a.timestamp);
            if(logs.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#444;padding:10px;">NO DATA</div>';
                return;
            }
            logs.forEach(log => {
                let content = '';
                let color = 'border-left-color: #666';
                if(log.category === 'finance') { 
                    content = `üí∏ ${log.tag} $${log.amount}`; color = 'border-left-color: var(--accent-blue)'; 
                    if(log.note) content += ` <span style="color:#666">(${log.note})</span>`;
                }
                if(log.category === 'diet') { content = `üî• ${log.tag} ${log.calories} cal`; color = 'border-left-color: var(--accent-green)'; }
                if(log.category === 'sleep') { content = `üí§ Sleep ${log.hours} hrs`; color = 'border-left-color: #fff'; }
                if(log.category === 'weight') { content = `‚öñÔ∏è ${log.weight} kg`; color = 'border-left-color: var(--accent)'; }
                if(log.category === 'fitness') { content = `üí™ Workout`; color = 'border-left-color: var(--accent-green)'; }
                
                list.innerHTML += `
                    <li class="log-item" style="${color}">
                        <div class="log-content">
                            <div class="log-date-label">${log.date}</div>
                            <div>${content}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteLog(${log.id})">√ó</button>
                    </li>`;
            });
        }

        function renderChart(logs) {
            const wrap = document.getElementById('weight-chart-wrapper');
            if(logs.length < 2) { wrap.innerHTML = '<div style="text-align:center;padding-top:80px;color:#444">Not enough data</div>'; return; }
            const w = logs.map(l=>l.weight);
            const min = Math.min(...w)-1, max = Math.max(...w)+1;
            const W = wrap.offsetWidth, H = wrap.offsetHeight;
            let points = logs.map((l,i) => {
                const x = (i/(logs.length-1)) * W;
                const y = H - ((l.weight-min)/(max-min)) * H;
                return `${x},${y}`;
            }).join(' ');
            wrap.innerHTML = `<svg><polyline points="${points}" /><circle cx="${(logs.length-1)/(logs.length-1)*W}" cy="${H - ((logs[logs.length-1].weight-min)/(max-min)) * H}" r="4" fill="var(--accent)" /></svg>`;
        }

        function addRecord(type) {
            let data = {};
            const selectedDate = document.getElementById('current-record-date').value;

            if (type === 'finance') {
                const tag = document.getElementById('finance-tag').value;
                const amt = parseFloat(document.getElementById('finance-amount').value);
                const note = document.getElementById('finance-note').value;
                if (!amt) return alert('Enter amount');
                data = { tag, amount: amt, note };
                document.getElementById('finance-amount').value = '';
                document.getElementById('finance-note').value = '';
            } else if (type === 'diet') {
                const tag = document.getElementById('diet-tag').value;
                const cal = parseFloat(document.getElementById('diet-cal').value);
                if (isNaN(cal)) return alert('Enter calories');
                data = { tag, calories: cal };
                document.getElementById('diet-cal').value = '';
            } else if (type === 'sleep') {
                const hrs = parseFloat(document.getElementById('sleep-input').value);
                if (!hrs) return alert('Enter hours');
                data = { hours: hrs };
                document.getElementById('sleep-input').value = '';
            } else if (type === 'weight') {
                const w = parseFloat(document.getElementById('weight-input').value);
                if (!w) return alert('Enter weight');
                data = { weight: w };
                document.getElementById('weight-input').value = '';
            } else if (type === 'fitness') {
                data = { note: 'Workout Session' };
            }

            const tx = db.transaction(['logs'], 'readwrite');
            tx.objectStore('logs').add({
                category: type,
                date: selectedDate,
                timestamp: Date.now(),
                ...data
            });
            tx.oncomplete = () => { refreshUI(); if(type!=='fitness') alert('Saved'); };
        }

        function refreshUI() {
            loadTags();
            loadHomeLogs();
            if(document.getElementById('view-stats').classList.contains('active')) calculateStats();
        }

        function loadTags() {
            const tx = db.transaction(['settings'], 'readonly');
            const store = tx.objectStore('settings');
            
            store.get('tags_finance').onsuccess = (e) => {
                const tags = e.target.result?.value || [];
                document.getElementById('finance-tag').innerHTML = tags.map(t=>`<option>${t}</option>`).join('');
            };
            store.get('tags_diet').onsuccess = (e) => {
                const tags = e.target.result?.value || [];
                document.getElementById('diet-tag').innerHTML = tags.map(t=>`<option>${t}</option>`).join('');
            };
            store.get('fitness_plan').onsuccess = (e) => {
                const plan = e.target.result?.value || '';
                renderChecklist(plan);
                
                // [ÈóúÈçµ‰øÆÊ≠£] Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á∑®ËºØÊ®°ÂºèÔºåÂ¶ÇÊûúÊòØÔºåÂ∞±‰∏çË¶ÜËìã‰ΩøÁî®ËÄÖÊ≠£Âú®ÊâìÁöÑÂÖßÂÆπ
                const listDiv = document.getElementById('checklist-view');
                if(listDiv && listDiv.style.display !== 'none') {
                    document.getElementById('fitness-plan-input').value = plan;
                }
            };
            renderGymTemplates();
        }

        function loadHomeLogs() {
            const selectedDate = document.getElementById('current-record-date').value;
            document.getElementById('log-list-date-label').innerText = selectedDate;
            const tx = db.transaction(['logs'], 'readonly');
            tx.objectStore('logs').getAll().onsuccess = (e) => {
                const logs = e.target.result;
                const list = document.getElementById('today-list');
                list.innerHTML = '';
                logs.filter(l => l.date === selectedDate).reverse().forEach(log => {
                    let content = '';
                    let color = 'border-left-color: #666';
                    if(log.category === 'finance') { 
                        content = `üí∏ ${log.tag} $${log.amount}`; color = 'border-left-color: var(--accent-blue)'; 
                        if(log.note) content += ` <span style="color:#666">(${log.note})</span>`;
                    }
                    if(log.category === 'diet') { content = `üî• ${log.tag} ${log.calories} cal`; color = 'border-left-color: var(--accent-green)'; }
                    if(log.category === 'sleep') { content = `üí§ Sleep ${log.hours} hrs`; color = 'border-left-color: #fff'; }
                    if(log.category === 'weight') { content = `‚öñÔ∏è ${log.weight} kg`; color = 'border-left-color: var(--accent)'; }
                    if(log.category === 'fitness') { content = `üí™ Workout`; color = 'border-left-color: var(--accent-green)'; }
                    
                    list.innerHTML += `
                        <li class="log-item" style="${color}">
                            <span>${content}</span>
                            <button class="delete-btn" onclick="deleteLog(${log.id})">√ó</button>
                        </li>`;
                });
            };
        }
        
        function deleteLog(id) {
            if(confirm('Delete?')) {
                const tx = db.transaction(['logs'], 'readwrite');
                tx.objectStore('logs').delete(id).onsuccess = refreshUI;
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(t === 'stats') calculateStats();
        }

        function renderTagsSetting() {
            const cat = document.getElementById('setting-category').value;
            const tx = db.transaction(['settings'], 'readonly');
            tx.objectStore('settings').get(`tags_${cat}`).onsuccess = (e) => {
                const d = document.getElementById('tags-display');
                d.innerHTML = (e.target.result?.value||[]).map(t=>`<span class="tag-chip" onclick="removeTag('${t}')">${t} √ó</span>`).join('');
            };
        }
        function openSettings(type) { switchTab('stats'); document.getElementById('setting-category').value = type; renderTagsSetting(); }
        function addNewTag() {
            const cat = document.getElementById('setting-category').value;
            const val = document.getElementById('new-tag-input').value;
            if(!val) return;
            const key = `tags_${cat}`;
            const tx = db.transaction(['settings'], 'readwrite');
            tx.objectStore('settings').get(key).onsuccess = (e) => {
                const arr = e.target.result?.value || [];
                if(!arr.includes(val)) { arr.push(val); tx.objectStore('settings').put({key, value: arr}).onsuccess=renderTagsSetting; }
            };
            document.getElementById('new-tag-input').value = '';
        }
        function removeTag(val) {
            const cat = document.getElementById('setting-category').value;
            const key = `tags_${cat}`;
            const tx = db.transaction(['settings'], 'readwrite');
            tx.objectStore('settings').get(key).onsuccess = (e) => {
                const arr = (e.target.result?.value||[]).filter(t=>t!==val);
                tx.objectStore('settings').put({key, value: arr}).onsuccess=renderTagsSetting;
            };
        }

        function exportData() {
            const tx = db.transaction(['logs', 'settings'], 'readonly');
            Promise.all([
                new Promise(r => tx.objectStore('logs').getAll().onsuccess = e => r(e.target.result)),
                new Promise(r => tx.objectStore('settings').getAll().onsuccess = e => r(e.target.result))
            ]).then(([logs, settings]) => {
                const blob = new Blob([JSON.stringify({logs, settings})], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `LifeLog_Backup.json`;
                a.click();
            });
        }
        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = db.transaction(['logs', 'settings'], 'readwrite');
                    tx.objectStore('logs').clear();
                    tx.objectStore('settings').clear();
                    data.logs.forEach(l => { delete l.id; tx.objectStore('logs').add(l); });
                    data.settings.forEach(s => tx.objectStore('settings').put(s));
                    tx.oncomplete = () => { alert('Restored!'); location.reload(); };
                } catch(err) { alert('Invalid File'); }
            };
            r.readAsText(file);
        }
        function clearAllData() {
            if(confirm('RESET APP?')) {
                indexedDB.deleteDatabase(DB_NAME);
                location.reload();
            }
        }
    </script>
</body>
</html>